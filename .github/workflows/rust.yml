name: Cargo Build & Test

on:
  push:
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  # =============================================================================
  # Format and Lint - Run first to catch obvious issues
  # =============================================================================
  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        # Exclude platform-specific crates that may have conditional compilation issues
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: clippy
      - name: Install FUSE (for oxidized-fuse)
        run: sudo apt-get update && sudo apt-get install -y fuse3 libfuse3-dev
      - name: Run Clippy (cross-platform crates)
        # Exclude macOS-only crates and GUI (needs webkit2gtk on Linux)
        run: |
          cargo clippy --workspace \
            --exclude oxidized-fskit \
            --exclude oxidized-gui \
            -- -D warnings

  # =============================================================================
  # Security Audit
  # =============================================================================
  security_audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Install cargo-deny
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny
      - name: Run cargo-deny
        run: cargo deny check
      - name: Run cargo-audit
        uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  # =============================================================================
  # MSRV Check - Verify minimum supported Rust version
  # =============================================================================
  msrv:
    name: MSRV Check (Rust 1.90)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust 1.90
        uses: dtolnay/rust-toolchain@1.90
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: msrv
      - name: Install FUSE
        run: sudo apt-get update && sudo apt-get install -y fuse3 libfuse3-dev
      - name: Check MSRV (cross-platform crates)
        run: |
          cargo check --workspace \
            --exclude oxidized-fskit \
            --exclude oxidized-gui

  # =============================================================================
  # Build and Test - Linux
  # =============================================================================
  build_and_test_linux:
    name: Build and Test (Linux)
    runs-on: ubuntu-latest
    needs: [format, clippy]
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: linux-build
      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest
      - name: Install FUSE
        run: sudo apt-get update && sudo apt-get install -y fuse3 libfuse3-dev
      - name: Build (default features)
        run: |
          cargo build --verbose --workspace \
            --exclude oxidized-fskit \
            --exclude oxidized-gui
      - name: Test (default features)
        run: |
          cargo nextest run --profile ci --workspace \
            --exclude oxidized-fskit \
            --exclude oxidized-gui
      - name: Build (no default features)
        run: |
          cargo build --verbose --no-default-features --workspace \
            --exclude oxidized-fskit \
            --exclude oxidized-gui \
            --exclude oxidized-bench
      - name: Test (no default features)
        run: |
          cargo nextest run --profile ci --no-default-features --workspace \
            --exclude oxidized-fskit \
            --exclude oxidized-gui \
            --exclude oxidized-bench
      - name: Run stress tests
        run: |
          cargo nextest run --profile ci -p oxidized-cryptolib \
            --features stress -E 'test(stress_)'

  # =============================================================================
  # Build and Test - macOS
  # =============================================================================
  build_and_test_macos:
    name: Build and Test (macOS)
    runs-on: macos-latest
    needs: [format]
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: macos-build
      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest
      - name: Install macFUSE
        run: |
          brew install --cask macfuse
      - name: Build cross-platform crates
        # Build crates that work on both platforms
        # Note: oxidized-fskit requires macOS 15.4+ and FSKitBridge.app
        # Note: oxidized-gui needs full Xcode for dioxus desktop
        run: |
          cargo build --verbose --workspace \
            --exclude oxidized-fskit \
            --exclude oxidized-gui
      - name: Test cross-platform crates
        run: |
          cargo nextest run --profile ci --workspace \
            --exclude oxidized-fskit \
            --exclude oxidized-gui \
            --exclude oxidized-fuse

  # =============================================================================
  # Build and Test - Windows (experimental)
  # =============================================================================
  build_windows:
    name: Build and Test (Windows)
    runs-on: windows-latest
    needs: [format]
    # Windows is not first-party - don't block PRs
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: windows-build
      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest
      - name: Build cryptolib
        run: cargo build -p oxidized-cryptolib --verbose
      - name: Test cryptolib
        run: cargo nextest run -p oxidized-cryptolib
      - name: Build CLI (no mount backends)
        run: cargo build -p oxidized-cli --no-default-features --verbose
      - name: Test CLI (no mount backends)
        run: cargo nextest run -p oxidized-cli --no-default-features
      - name: Build CLI with WebDAV
        run: cargo build -p oxidized-cli --features webdav --verbose
      - name: Build WebDAV crate
        run: cargo build -p oxidized-webdav --verbose

  # =============================================================================
  # FSKit Build and Test (macOS 15+)
  # =============================================================================
  # Note: FSKit extension registration requires code signing and user approval,
  # which can't be fully automated in CI. We test what we can:
  # - Build verification (compile check)
  # - Unit tests (don't require running FSKitBridge)
  # - Setup module tests (detection logic)
  #
  # Full integration testing requires a signed FSKitBridge.app and manual
  # extension approval in System Settings.
  # =============================================================================
  fskit_build:
    name: FSKit Build (macOS 15)
    runs-on: macos-15
    needs: [format]
    # FSKit is experimental - don't block PRs on failures
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6

      - name: Check macOS version
        run: |
          echo "macOS version: $(sw_vers -productVersion)"
          echo "Build version: $(sw_vers -buildVersion)"

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: macos-fskit

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Install protoc (for fskit-rs)
        run: brew install protobuf

      - name: Build oxidized-fskit
        run: cargo build -p oxidized-fskit --verbose

      - name: Build oxidized-fskit with setup feature
        run: cargo build -p oxidized-fskit --features setup --verbose

      - name: Build oxfskit-setup tool
        run: cargo build -p oxidized-fskit --features setup --bin oxfskit-setup --release

      - name: Install FSKitBridge using oxfskit-setup
        run: |
          echo "=== Installing FSKitBridge using oxfskit-setup ==="
          # Install to /Applications (requires no sudo on macOS runners)
          ./target/release/oxfskit-setup install --dest /Applications --no-launch
        continue-on-error: true

      - name: Attempt FSKitBridge registration
        # This step is best-effort - full registration requires signing and user approval
        continue-on-error: true
        run: |
          echo "=== Attempting FSKitBridge registration ==="

          # Launch using our tool
          ./target/release/oxfskit-setup launch || echo "Launch returned non-zero (may need extension approval)"
          sleep 3

          # Check if extension is registered (it likely won't be fully enabled)
          APPEX_PATH="/Applications/FSKitBridge.app/Contents/Extensions/FSKitExt.appex"
          if [ -d "$APPEX_PATH" ]; then
            echo "Extension bundle found at: $APPEX_PATH"

            # Try to register with pluginkit
            pluginkit -a "$APPEX_PATH" 2>&1 || echo "pluginkit -a returned non-zero (expected without signing)"

            # Get bundle ID
            BUNDLE_ID=$(defaults read "$APPEX_PATH/Contents/Info.plist" CFBundleIdentifier 2>/dev/null || echo "")
            if [ -n "$BUNDLE_ID" ]; then
              echo "Extension bundle ID: $BUNDLE_ID"
              pluginkit -e use -i "$BUNDLE_ID" 2>&1 || echo "pluginkit -e returned non-zero (expected)"
            fi
          else
            echo "Extension bundle not found at expected path"
          fi

          # List any registered FSKit extensions
          echo ""
          echo "=== Registered FSKit extensions ==="
          pluginkit -m -v 2>/dev/null | grep -i fskit || echo "No FSKit extensions registered"

      - name: Check FSKitBridge status
        continue-on-error: true
        run: |
          echo "=== FSKitBridge Status ==="
          ./target/release/oxfskit-setup status --json || true
          echo ""
          echo "=== Ping Check ==="
          ./target/release/oxfskit-setup ping --timeout 5 || echo "Ping failed (extension not running)"

      - name: Run oxidized-fskit unit tests
        run: cargo nextest run -p oxidized-fskit --profile ci

      - name: Run oxidized-fskit setup module tests
        run: cargo nextest run -p oxidized-fskit --features setup --profile ci

      - name: Run clippy on oxidized-fskit
        run: cargo clippy -p oxidized-fskit --features setup -- -D warnings
        continue-on-error: true

  # =============================================================================
  # FSKit Integration Tests (macOS 15+ with full setup)
  # =============================================================================
  # This job runs more comprehensive tests but requires:
  # - macOS 15.4+ runner
  # - FSKitBridge installed and extension enabled
  # Currently experimental and expected to fail in most CI environments.
  # =============================================================================
  fskit_integration:
    name: FSKit Integration Tests (macOS 15)
    runs-on: macos-15
    needs: [fskit_build]
    # Integration tests require extension approval - expected to fail
    continue-on-error: true
    # Only run on main branch or with explicit label
    if: github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'run-fskit-integration')
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: macos-fskit

      - name: Install protoc
        run: brew install protobuf

      - name: Build oxfskit-setup tool
        run: cargo build -p oxidized-fskit --features setup --bin oxfskit-setup --release

      - name: Install FSKitBridge using oxfskit-setup
        run: |
          echo "=== Installing FSKitBridge using oxfskit-setup ==="
          ./target/release/oxfskit-setup install --dest /Applications
        continue-on-error: true

      - name: Check FSKitBridge status
        run: |
          echo "=== FSKitBridge Status ==="
          ./target/release/oxfskit-setup status || true
          echo ""
          echo "=== Ping Check ==="
          ./target/release/oxfskit-setup ping --timeout 10 || echo "FSKitBridge not responding - integration tests will be skipped"

      - name: Build release binary
        run: cargo build -p oxidized-fskit --release

      - name: Run mount test (if FSKitBridge available)
        continue-on-error: true
        run: |
          # Check if FSKitBridge is responding using our tool
          if ! ./target/release/oxfskit-setup ping --timeout 5 2>/dev/null; then
            echo "FSKitBridge not available, skipping mount test"
            exit 0
          fi

          echo "FSKitBridge available, attempting mount test..."
          # TODO: Add actual mount integration test here
          # For now, just verify the binary runs
          cargo run -p oxidized-fskit --bin oxmount-fskit -- --help || true

  # =============================================================================
  # FUSE Integration Tests (Linux)
  # =============================================================================
  fuse_tests:
    name: FUSE Integration Tests
    runs-on: ubuntu-latest
    needs: [build_and_test_linux]
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: linux-build
      - name: Install FUSE
        run: sudo apt-get update && sudo apt-get install -y fuse3 libfuse3-dev
      - name: Build oxidized-fuse (release)
        run: cargo build --release -p oxidized-fuse
      - name: Run Rust mount tests
        run: |
          cargo test -p oxidized-fuse --test mount_tests -- --ignored --test-threads=1 2>&1 || echo "Some mount tests failed (expected in CI without proper FUSE setup)"
        continue-on-error: true

  pjdfstest_rust:
    name: POSIX Compliance (Rust pjdfstest)
    runs-on: ubuntu-latest
    needs: [build_and_test_linux]
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: linux-build
      - name: Install FUSE and pjdfstest dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse3 libfuse3-dev autoconf automake libtool perl
      - name: Build pjdfstest
        run: |
          git clone --depth 1 https://github.com/pjd/pjdfstest.git /tmp/pjdfstest
          cd /tmp/pjdfstest
          autoreconf -ifs
          ./configure
          make
      - name: Run Rust pjdfstest (passing tests)
        env:
          PJDFSTEST_BIN: /tmp/pjdfstest/pjdfstest
        run: |
          # Run the pjdfstest tests that are known to pass
          cargo test -p oxidized-fuse --test pjdfstest "mkdir" -- --ignored --test-threads=1 --nocapture
          cargo test -p oxidized-fuse --test pjdfstest "open" -- --ignored --test-threads=1 --nocapture
          cargo test -p oxidized-fuse --test pjdfstest "symlink" -- --ignored --test-threads=1 --nocapture

  fsx_tests:
    name: FSX Data Integrity Tests
    runs-on: ubuntu-latest
    needs: [build_and_test_linux]
    if: github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'run-fsx')
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: linux-build
      - name: Install FUSE
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse3 libfuse3-dev
      - name: Install fsx
        run: cargo install fsx
      - name: Build oxidized-fuse (release)
        run: cargo build --release -p oxidized-fuse
      - name: Run FSX tests (known failures)
        run: |
          cargo test -p oxidized-fuse --test fsx_tests test_fsx_quick -- --ignored --nocapture || echo "FSX quick test failed (expected - file visibility bug)"
        continue-on-error: true

  fsstress_tests:
    name: fsstress Concurrency Tests
    runs-on: ubuntu-latest
    needs: [build_and_test_linux]
    if: github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'run-fsstress')
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: linux-build
      - name: Install FUSE and build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse3 libfuse3-dev build-essential
      - name: Build fsstress
        run: |
          git clone --depth 1 https://github.com/billziss-gh/secfs.test.git /tmp/secfs.test
          cd /tmp/secfs.test/fsstress
          make
      - name: Build oxidized-fuse (release)
        run: cargo build --release -p oxidized-fuse
      - name: Run fsstress tests
        env:
          FSSTRESS_BIN: /tmp/secfs.test/fsstress/fsstress
        run: |
          cargo test -p oxidized-fuse --test fsstress_tests -- --ignored --nocapture || echo "fsstress tests completed (may have failures)"
        continue-on-error: true

  pjdfstest_shell:
    name: POSIX Compliance (Shell pjdfstest)
    runs-on: ubuntu-latest
    needs: [build_and_test_linux]
    if: github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'run-pjdfstest')
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: linux-build
      - name: Install FUSE and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse3 libfuse3-dev autoconf automake libtool perl
      - name: Build oxidized-fuse (release)
        run: cargo build --release -p oxidized-fuse
      - name: Build pjdfstest
        run: |
          git clone --depth 1 https://github.com/pjd/pjdfstest.git
          cd pjdfstest
          autoreconf -ifs
          ./configure
          make
      - name: Run pjdfstest (quick mode)
        run: sudo ./scripts/run-pjdfstest.sh --quick --pjdfstest ./pjdfstest
        continue-on-error: true

  # =============================================================================
  # Code Coverage
  # =============================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: [build_and_test_linux]
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: coverage
      - name: Install cargo-llvm-cov and nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov,nextest
      - name: Install FUSE
        run: sudo apt-get update && sudo apt-get install -y fuse3 libfuse3-dev
      - name: Generate coverage report
        run: |
          cargo llvm-cov nextest --workspace \
            --exclude oxidized-fskit \
            --exclude oxidized-gui \
            --html
          cargo llvm-cov nextest --workspace \
            --exclude oxidized-fskit \
            --exclude oxidized-gui \
            --lcov --output-path lcov.info
      - name: Upload coverage report
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: |
            target/llvm-cov/html/
            lcov.info

  # =============================================================================
  # Documentation Build
  # =============================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    needs: [format]
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: docs
      - name: Install FUSE
        run: sudo apt-get update && sudo apt-get install -y fuse3 libfuse3-dev
      - name: Build documentation
        run: |
          cargo doc --workspace --no-deps \
            --exclude oxidized-fskit \
            --exclude oxidized-gui
        env:
          RUSTDOCFLAGS: "-D warnings"
