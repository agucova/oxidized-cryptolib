name: Cargo Build & Test

on:
  push:
  pull_request:

env:
  CARGO_TERM_COLOR: always
  # Use fast KDF for most CI jobs (set OXCRYPT_FAST_KDF=0 where production KDF is needed)
  OXCRYPT_FAST_KDF: 1

jobs:
  # =============================================================================
  # Format and Lint - Run first to catch obvious issues
  # =============================================================================
  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: clippy
      - name: Install FUSE (for oxidized-fuse)
        run: sudo apt-get update && sudo apt-get install -y fuse3 libfuse3-dev
      - name: Run Clippy (cross-platform crates)
        # Exclude macOS-only crates and GUI (needs webkit2gtk on Linux)
        run: |
          cargo clippy --workspace \
            --exclude oxidized-fskit-legacy \
            --exclude oxidized-fskit-legacy-ffi \
            --exclude oxidized-gui \
            -- -D warnings

  # =============================================================================
  # Security Audit
  # =============================================================================
  security_audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Install cargo-deny
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny
      - name: Run cargo-deny
        run: cargo deny check
      - name: Run cargo-audit
        uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  # =============================================================================
  # MSRV Check - Verify minimum supported Rust version
  # =============================================================================
  msrv:
    name: MSRV Check (Rust 1.90)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust 1.90
        uses: dtolnay/rust-toolchain@1.90
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: msrv
      - name: Install FUSE
        run: sudo apt-get update && sudo apt-get install -y fuse3 libfuse3-dev
      - name: Check MSRV (cross-platform crates)
        run: |
          cargo check --workspace \
            --exclude oxidized-fskit-legacy \
            --exclude oxidized-fskit-legacy-ffi \
            --exclude oxidized-gui

  # =============================================================================
  # Unit Tests - Fast tests on cryptolib (runs on all platforms)
  # =============================================================================
  unit_tests:
    name: Unit Tests
    runs-on: ${{ matrix.os }}
    needs: [format, clippy]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: unit-${{ matrix.os }}
      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest
      - name: Run unit tests (--profile unit)
        run: cargo nextest run --profile unit
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: junit-unit-${{ matrix.os }}
          path: target/nextest/unit/junit.xml

  # =============================================================================
  # Integration Tests - Linux
  # =============================================================================
  integration_linux:
    name: Integration Tests (Linux)
    runs-on: ubuntu-latest
    needs: [unit_tests]
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: linux-integration
      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest
      - name: Install FUSE
        run: sudo apt-get update && sudo apt-get install -y fuse3 libfuse3-dev

      - name: Build workspace
        run: |
          cargo build --workspace \
            --exclude oxidized-fskit-legacy \
            --exclude oxidized-fskit-legacy-ffi \
            --exclude oxidized-gui

      - name: Run integration tests (--profile integration)
        run: |
          cargo nextest run --profile integration \
            --workspace \
            --exclude oxidized-fskit-legacy \
            --exclude oxidized-fskit-legacy-ffi \
            --exclude oxidized-gui

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: junit-integration-linux
          path: target/nextest/integration/junit.xml

  # =============================================================================
  # Stress Tests - Linux (slow, resource-intensive)
  # =============================================================================
  stress_tests:
    name: Stress Tests (Linux)
    runs-on: ubuntu-latest
    needs: [integration_linux]
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: linux-integration
      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest
      - name: Install FUSE
        run: sudo apt-get update && sudo apt-get install -y fuse3 libfuse3-dev

      - name: Run stress tests (--profile stress)
        run: |
          cargo nextest run --profile stress \
            -p oxidized-cryptolib

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: junit-stress
          path: target/nextest/stress/junit.xml

  # =============================================================================
  # No Default Features - Verify minimal build works
  # =============================================================================
  no_default_features:
    name: Build (no default features)
    runs-on: ubuntu-latest
    needs: [format]
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: no-default
      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest
      - name: Install FUSE
        run: sudo apt-get update && sudo apt-get install -y fuse3 libfuse3-dev
      - name: Build (no default features)
        run: |
          cargo build --no-default-features --workspace \
            --exclude oxidized-fskit-legacy \
            --exclude oxidized-fskit-legacy-ffi \
            --exclude oxidized-gui \
            --exclude oxidized-bench
      - name: Test (no default features)
        run: |
          cargo nextest run --profile unit --no-default-features \
            -p oxidized-cryptolib

  # =============================================================================
  # Integration Tests - macOS
  # =============================================================================
  integration_macos:
    name: Integration Tests (macOS)
    runs-on: macos-latest
    needs: [unit_tests]
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: macos-integration
      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest
      - name: Install macFUSE
        run: brew install --cask macfuse

      - name: Build workspace
        run: |
          cargo build --workspace \
            --exclude oxidized-fskit-legacy \
            --exclude oxidized-fskit-legacy-ffi \
            --exclude oxidized-gui

      - name: Run integration tests (--profile integration)
        # Exclude oxidized-fuse on macOS (macFUSE requires kernel extension approval)
        run: |
          cargo nextest run --profile integration \
            --workspace \
            --exclude oxidized-fskit-legacy \
            --exclude oxidized-fskit-legacy-ffi \
            --exclude oxidized-gui \
            --exclude oxidized-fuse

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: junit-integration-macos
          path: target/nextest/integration/junit.xml

  # =============================================================================
  # Windows Build (experimental)
  # =============================================================================
  build_windows:
    name: Build (Windows)
    runs-on: windows-latest
    needs: [format]
    # Windows is not first-party - don't block PRs
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: windows-build
      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Run unit tests (--profile unit)
        run: cargo nextest run --profile unit

      - name: Build CLI (no mount backends)
        run: cargo build -p oxidized-cli --no-default-features --verbose

      - name: Build CLI with WebDAV
        run: cargo build -p oxidized-cli --features webdav --verbose

      - name: Build WebDAV crate
        run: cargo build -p oxidized-webdav --verbose

  # =============================================================================
  # FSKit Build and Test (macOS 15+)
  # =============================================================================
  fskit_build:
    name: FSKit Build (macOS 15)
    runs-on: macos-15
    needs: [format]
    # FSKit is experimental - don't block PRs on failures
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6

      - name: Check macOS version
        run: |
          echo "macOS version: $(sw_vers -productVersion)"
          echo "Build version: $(sw_vers -buildVersion)"

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: macos-fskit

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Install protoc (for fskit-rs)
        run: brew install protobuf

      - name: Build oxidized-fskit-legacy
        run: cargo build -p oxidized-fskit-legacy --verbose

      - name: Build oxidized-fskit-legacy with setup feature
        run: cargo build -p oxidized-fskit-legacy --features setup --verbose

      - name: Build oxfskit-setup tool
        run: cargo build -p oxidized-fskit-legacy --features setup --bin oxfskit-setup --release

      - name: Install FSKitBridge using oxfskit-setup
        run: |
          echo "=== Installing FSKitBridge using oxfskit-setup ==="
          ./target/release/oxfskit-setup install --dest /Applications --no-launch
        continue-on-error: true

      - name: Attempt FSKitBridge registration
        continue-on-error: true
        run: |
          echo "=== Attempting FSKitBridge registration ==="
          ./target/release/oxfskit-setup launch || echo "Launch returned non-zero (may need extension approval)"
          sleep 3
          APPEX_PATH="/Applications/FSKitBridge.app/Contents/Extensions/FSKitExt.appex"
          if [ -d "$APPEX_PATH" ]; then
            echo "Extension bundle found at: $APPEX_PATH"
            pluginkit -a "$APPEX_PATH" 2>&1 || echo "pluginkit -a returned non-zero (expected without signing)"
            BUNDLE_ID=$(defaults read "$APPEX_PATH/Contents/Info.plist" CFBundleIdentifier 2>/dev/null || echo "")
            if [ -n "$BUNDLE_ID" ]; then
              echo "Extension bundle ID: $BUNDLE_ID"
              pluginkit -e use -i "$BUNDLE_ID" 2>&1 || echo "pluginkit -e returned non-zero (expected)"
            fi
          else
            echo "Extension bundle not found at expected path"
          fi
          echo ""
          echo "=== Registered FSKit extensions ==="
          pluginkit -m -v 2>/dev/null | grep -i fskit || echo "No FSKit extensions registered"

      - name: Check FSKitBridge status
        continue-on-error: true
        run: |
          echo "=== FSKitBridge Status ==="
          ./target/release/oxfskit-setup status --json || true
          echo ""
          echo "=== Ping Check ==="
          ./target/release/oxfskit-setup ping --timeout 5 || echo "Ping failed (extension not running)"

      - name: Run oxidized-fskit-legacy unit tests (--profile unit)
        run: cargo nextest run -p oxidized-fskit-legacy --profile unit

      - name: Run oxidized-fskit-legacy setup module tests
        run: cargo nextest run -p oxidized-fskit-legacy --features setup --profile unit

      - name: Run clippy on oxidized-fskit-legacy
        run: cargo clippy -p oxidized-fskit-legacy --features setup -- -D warnings
        continue-on-error: true

  # =============================================================================
  # FSKit Integration Tests (macOS 15+ with full setup)
  # =============================================================================
  fskit_integration:
    name: FSKit Integration Tests (macOS 15)
    runs-on: macos-15
    needs: [fskit_build]
    continue-on-error: true
    if: github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'run-fskit-integration')
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: macos-fskit

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Install protoc
        run: brew install protobuf

      - name: Build oxfskit-setup tool
        run: cargo build -p oxidized-fskit-legacy --features setup --bin oxfskit-setup --release

      - name: Install FSKitBridge using oxfskit-setup
        run: |
          echo "=== Installing FSKitBridge using oxfskit-setup ==="
          ./target/release/oxfskit-setup install --dest /Applications
        continue-on-error: true

      - name: Check FSKitBridge status
        run: |
          echo "=== FSKitBridge Status ==="
          ./target/release/oxfskit-setup status || true
          echo ""
          echo "=== Ping Check ==="
          ./target/release/oxfskit-setup ping --timeout 10 || echo "FSKitBridge not responding - integration tests will be skipped"

      - name: Build release binary
        run: cargo build -p oxidized-fskit-legacy --release

      - name: Run mount integration tests (--profile mounts)
        continue-on-error: true
        run: |
          if ! ./target/release/oxfskit-setup ping --timeout 5 2>/dev/null; then
            echo "FSKitBridge not available, skipping mount test"
            exit 0
          fi
          echo "FSKitBridge available, running mount tests..."
          cargo nextest run -p oxidized-fskit-legacy --profile mounts --features fskit-tests || true

  # =============================================================================
  # FUSE Mount Tests (Linux) - Requires privileged access
  # =============================================================================
  fuse_mount_tests:
    name: FUSE Mount Tests (Linux)
    runs-on: ubuntu-latest
    needs: [integration_linux]
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: linux-integration
      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest
      - name: Install FUSE
        run: sudo apt-get update && sudo apt-get install -y fuse3 libfuse3-dev

      - name: Build oxidized-fuse (release)
        run: cargo build --release -p oxidized-fuse

      - name: Run FUSE mount tests (--profile mounts)
        run: |
          cargo nextest run -p oxidized-fuse --profile mounts --features fuse-tests 2>&1 || echo "Some mount tests failed (expected in CI without proper FUSE setup)"
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: junit-fuse-mounts
          path: target/nextest/mounts/junit.xml

  # =============================================================================
  # POSIX Compliance Tests (pjdfstest)
  # =============================================================================
  pjdfstest:
    name: POSIX Compliance (pjdfstest)
    runs-on: ubuntu-latest
    needs: [integration_linux]
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: linux-integration
      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest
      - name: Install FUSE and pjdfstest dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse3 libfuse3-dev autoconf automake libtool perl

      - name: Build pjdfstest
        run: |
          git clone --depth 1 https://github.com/pjd/pjdfstest.git /tmp/pjdfstest
          cd /tmp/pjdfstest
          autoreconf -ifs
          ./configure
          make

      - name: Run pjdfstest via Rust harness (--profile stress)
        env:
          PJDFSTEST_BIN: /tmp/pjdfstest/pjdfstest
        run: |
          cargo nextest run -p oxidized-fuse --profile stress --features fuse-tests \
            -E 'test(/pjdfstest/)' -- --nocapture || true
        continue-on-error: true

  # =============================================================================
  # FSX Data Integrity Tests
  # =============================================================================
  fsx_tests:
    name: FSX Data Integrity Tests
    runs-on: ubuntu-latest
    needs: [integration_linux]
    if: github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'run-fsx')
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: linux-integration
      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest
      - name: Install FUSE
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse3 libfuse3-dev

      - name: Install fsx
        run: cargo install fsx

      - name: Build oxidized-fuse (release)
        run: cargo build --release -p oxidized-fuse

      - name: Run FSX tests (--profile stress)
        run: |
          cargo nextest run -p oxidized-fuse --profile stress --features fuse-tests \
            -E 'test(/fsx/)' -- --nocapture || echo "FSX tests completed"
        continue-on-error: true

  # =============================================================================
  # fsstress Concurrency Tests
  # =============================================================================
  fsstress_tests:
    name: fsstress Concurrency Tests
    runs-on: ubuntu-latest
    needs: [integration_linux]
    if: github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'run-fsstress')
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: linux-integration
      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest
      - name: Install FUSE and build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse3 libfuse3-dev build-essential

      - name: Build fsstress
        run: |
          git clone --depth 1 https://github.com/billziss-gh/secfs.test.git /tmp/secfs.test
          cd /tmp/secfs.test/fsstress
          make

      - name: Build oxidized-fuse (release)
        run: cargo build --release -p oxidized-fuse

      - name: Run fsstress tests (--profile stress)
        env:
          FSSTRESS_BIN: /tmp/secfs.test/fsstress/fsstress
        run: |
          cargo nextest run -p oxidized-fuse --profile stress --features fuse-tests \
            -E 'test(/fsstress/)' -- --nocapture || echo "fsstress tests completed"
        continue-on-error: true

  # =============================================================================
  # Full CI Suite (production KDF, all tests)
  # =============================================================================
  ci_full:
    name: Full CI Suite (production KDF)
    runs-on: ubuntu-latest
    needs: [integration_linux, stress_tests]
    if: github.ref == 'refs/heads/main'
    env:
      # Use production KDF for thorough testing on main branch
      OXCRYPT_FAST_KDF: 0
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: linux-ci-full
      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest
      - name: Install FUSE
        run: sudo apt-get update && sudo apt-get install -y fuse3 libfuse3-dev

      - name: Run full CI suite (--profile ci)
        run: |
          cargo nextest run --profile ci \
            --workspace \
            --exclude oxidized-fskit-legacy \
            --exclude oxidized-fskit-legacy-ffi \
            --exclude oxidized-gui

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: junit-ci-full
          path: target/nextest/ci/junit.xml

  # =============================================================================
  # Code Coverage
  # =============================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: [integration_linux]
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: coverage
      - name: Install cargo-llvm-cov and nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov,nextest
      - name: Install FUSE
        run: sudo apt-get update && sudo apt-get install -y fuse3 libfuse3-dev

      - name: Generate coverage report (unit + integration)
        run: |
          cargo llvm-cov nextest --profile unit \
            --workspace \
            --exclude oxidized-fskit-legacy \
            --exclude oxidized-fskit-legacy-ffi \
            --exclude oxidized-gui \
            --html
          cargo llvm-cov nextest --profile unit \
            --workspace \
            --exclude oxidized-fskit-legacy \
            --exclude oxidized-fskit-legacy-ffi \
            --exclude oxidized-gui \
            --lcov --output-path lcov.info

      - name: Upload coverage report
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: |
            target/llvm-cov/html/
            lcov.info

  # =============================================================================
  # Documentation Build
  # =============================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    needs: [format]
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: docs
      - name: Install FUSE
        run: sudo apt-get update && sudo apt-get install -y fuse3 libfuse3-dev
      - name: Build documentation
        run: |
          cargo doc --workspace --no-deps \
            --exclude oxidized-fskit-legacy \
            --exclude oxidized-fskit-legacy-ffi \
            --exclude oxidized-gui
        env:
          RUSTDOCFLAGS: "-D warnings"
